{% extends "layout.html" %}

{% block title %}Aqua Track: Water Quality Monitoring System - Dashboard{% endblock %}

{% block content %}
        <div class="row g-4">
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="card shadow h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">WQI Calculator</h5>
                        <p class="card-text">Input water parameters and compute the WQI.</p>
                        <a class="btn btn-primary mt-auto" href="{{ url_for('home') }}">Open Calculator</a>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="card shadow h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">WQI Map</h5>
                        <p class="card-text">Explore WQI across locations on Google Maps.</p>
                        <a class="btn btn-primary mt-auto" href="{{ url_for('map_page') }}">Open Map</a>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="card shadow h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Database</h5>
                        <p class="card-text">View and manage locations and samples.</p>
                        <a class="btn btn-primary mt-auto" href="{{ url_for('data_page') }}">Open Database</a>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="card shadow h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">
                            <img src="{{ url_for('static', filename='img/chatbot-icon.jpg') }}" alt="Chatbot icon" class="chatbot-icon">
                            Chatbot
                        </h5>
                        <p class="card-text">Ask Hydra about water quality and more.</p>
                        <a class="btn btn-primary mt-auto" href="{{ url_for('chatbot_page') }}">Open Chatbot</a>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="card shadow h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">Live Sensor Data</h5>
                        <p class="card-text mb-1">See the latest reading from the ESP32 sensor.</p>
                        <p id="dashboard-sensor-status" class="small text-muted mb-2">
                            Waiting for sensor dataâ€¦
                        </p>
                        <ul class="list-unstyled small mb-3">
                            <li>ðŸŒ¡ Temperature: <span id="dash-temp">â€”</span> Â°C</li>
                            <li>ðŸ§ª pH: <span id="dash-ph">â€”</span></li>
                            <li>ðŸŒ« Turbidity: <span id="dash-turbidity">â€”</span></li>
                        </ul>
                        <a class="btn btn-primary mt-auto" href="{{ url_for('sensors_page') }}">Open Sensor Page</a>
                    </div>
                </div>
            </div>          
            
        </div>
        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow slogan-card">
                    <div class="card-body d-flex flex-column flex-lg-row align-items-center">
                        <div class="flex-grow-1 pe-lg-4">
                            <div class="slogan-title">
                                When water quality is ignored, sickness is guaranteed.<br>
                                WQI is the last line between safety and suffering.
                            </div>
                            <div class="slogan-subtext text-muted mt-2">
                                Protect your family: check the water before you drink.
                            </div>
                        </div>
                        <div class="water-art mt-4 mt-lg-0">
                            <svg width="260" height="180" viewBox="0 0 260 180" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <linearGradient id="dropGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" stop-color="#6be3ff"/>
                                        <stop offset="100%" stop-color="#08799f"/>
                                    </linearGradient>
                                </defs>
                                <g>
                                    <path d="M130 15 C120 35 95 70 85 95 C75 120 90 150 130 150 C170 150 185 120 175 95 C165 70 140 35 130 15 Z"
                                          fill="url(#dropGrad)" opacity="0.95"/>
                                    <circle cx="145" cy="85" r="8" fill="#ffffff" opacity="0.6"/>
                                </g>
                                <g class="waves">
                                    <path d="M0 120 C35 110 70 130 105 120 C140 110 175 130 210 120 C245 110 280 130 315 120 L315 180 L0 180 Z"
                                          fill="#25c7e8" opacity="0.35"/>
                                </g>
                                <g class="waves">
                                    <path d="M0 135 C35 125 70 145 105 135 C140 125 175 145 210 135 C245 125 280 145 315 135 L315 180 L0 180 Z"
                                          fill="#0fa7cf" opacity="0.35"/>
                                </g>
                                <g transform="translate(20,20)">
                                    <rect x="0" y="0" width="70" height="70" rx="12" fill="#082532" opacity="0.85"/>
                                    <text x="35" y="44" font-size="26" text-anchor="middle" fill="#ffffff" font-weight="700">WQI</text>
                                </g>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const statusEl = document.getElementById('dashboard-sensor-status');
    const tempEl = document.getElementById('dash-temp');
    const phEl = document.getElementById('dash-ph');
    const turbEl = document.getElementById('dash-turbidity');

    async function refreshDashboardSensor() {
        try {
            const res = await fetch('/api/iot');
            if (!res.ok) {
                statusEl.textContent = 'Waiting for sensor dataâ€¦';
                tempEl.textContent = 'â€”';
                phEl.textContent = 'â€”';
                turbEl.textContent = 'â€”';
                return;
            }
            const item = await res.json();
            const hasAny = item && (item.temperature_c != null || item.ph != null || item.turbidity != null);
            if (!hasAny) {
                statusEl.textContent = 'Waiting for sensor dataâ€¦';
                tempEl.textContent = 'â€”';
                phEl.textContent = 'â€”';
                turbEl.textContent = 'â€”';
                return;
            }
            statusEl.textContent = 'Live sensor data received.';
            tempEl.textContent = item.temperature_c != null ? Number(item.temperature_c).toFixed(2) : 'â€”';
            phEl.textContent = item.ph != null ? Number(item.ph).toFixed(2) : 'â€”';
            turbEl.textContent = item.turbidity != null ? Number(item.turbidity).toFixed(2) : 'â€”';
        } catch (e) {
            statusEl.textContent = 'Waiting for sensor dataâ€¦';
            tempEl.textContent = 'â€”';
            phEl.textContent = 'â€”';
            turbEl.textContent = 'â€”';
        }
    }

    refreshDashboardSensor();
    setInterval(refreshDashboardSensor, 10000);
});
</script>
{% endblock %}
